# é€±æ¬¡ãƒ†ãƒ¼ãƒæ±ºå®š + Discordé€šçŸ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# æ¯é€±æ—¥æ›œ 09:00 JST ã«ãƒ—ãƒ¼ãƒ«æ®‹æ•°ã‚’ç¢ºèªã—ã€
# Discord ã«ãƒ†ãƒ¼ãƒæ±ºå®šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚
#
# ãƒ†ãƒ¼ãƒæ±ºå®š â†’ C1-C7 â†’ convert_c7_to_pool.ts ã®æµã‚Œã¯
# ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆClaude Codeï¼‰ã§å®Ÿæ–½ã—ã€çµæœã‚’pushã™ã‚‹ã€‚
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã¨æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’æ‹…å½“ã€‚

name: Weekly Theme & Notifications

permissions:
  contents: write

on:
  schedule:
    # æ¯é€±æ—¥æ›œ 00:00 UTC = JST 09:00ï¼ˆãƒ†ãƒ¼ãƒæ±ºå®šãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰
    - cron: '0 0 * * 0'
    # æ¯æ—¥ 12:00 UTC = JST 21:00ï¼ˆæ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼‰
    - cron: '0 12 * * *'
    # æ¯é€±åœŸæ›œ 06:00 UTC = JST 15:00ï¼ˆé€±æ¬¡æŒ¯ã‚Šè¿”ã‚Šï¼‰
    - cron: '0 6 * * 6'

  workflow_dispatch:
    inputs:
      action:
        description: 'é€šçŸ¥ã‚¿ã‚¤ãƒ—'
        required: true
        type: choice
        options:
          - theme-candidates
          - daily-report
          - weekly-review

env:
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
  DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}

jobs:
  # ===== ãƒ†ãƒ¼ãƒå€™è£œé€šçŸ¥ï¼ˆæ¯é€±æ—¥æ›œï¼‰=====
  theme_notify:
    if: github.event.schedule == '0 0 * * 0' || github.event.inputs.action == 'theme-candidates'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Check pool status
        id: pool
        run: |
          POOL_COUNT=$(cat content/ab_test_pool.yml 2>/dev/null | grep -c "status: active" || echo "0")
          echo "count=$POOL_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«æ®‹æ•°: $POOL_COUNT"

      - name: Research overseas trends & academic papers
        run: |
          echo "ğŸ“š æµ·å¤–è«–æ–‡ + ãƒˆãƒ¬ãƒ³ãƒ‰ãƒªã‚µãƒ¼ãƒã‚’å®Ÿè¡Œ..."
          npx ts-node scripts/research_overseas.ts || true
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true

      - name: Send theme candidates notification
        run: npx ts-node scripts/notify_discord.ts theme-candidates

      - name: Warn if pool is critically low
        if: steps.pool.outputs.count < 3
        run: |
          echo "âš ï¸ æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«ãŒæ¯æ¸‡å¯¸å‰ã§ã™ï¼"
          # ç·Šæ€¥é€šçŸ¥ã‚’è¿½åŠ ã§é€ä¿¡
          npx ts-node scripts/notify_discord.ts daily-report

  # ===== æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ¯æ—¥ 21:00 JSTï¼‰=====
  daily_report:
    if: github.event.schedule == '0 12 * * *' || github.event.inputs.action == 'daily-report'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Send daily report
        run: npx ts-node scripts/notify_discord.ts daily-report

  # ===== é€±æ¬¡æŒ¯ã‚Šè¿”ã‚Šï¼ˆæ¯é€±åœŸæ›œ 15:00 JSTï¼‰=====
  weekly_review:
    if: github.event.schedule == '0 6 * * 6' || github.event.inputs.action == 'weekly-review'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Collect weekly metrics
        run: npm run metrics || true
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        continue-on-error: true

      - name: Run hypothesis analysis & verification
        run: |
          echo "ğŸ“Š XAS + 7è»¸å¸°å±åˆ†æã‚’å®Ÿè¡Œ..."
          npx ts-node scripts/analyze_hypothesis.ts analyze || true
          echo "ğŸ”¬ ä»®èª¬æ¤œè¨¼ã‚’å®Ÿè¡Œ..."
          npx ts-node scripts/analyze_hypothesis.ts verify || true
          echo "ğŸ¯ æ¬¡å›æŠ•ç¨¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨è–¦..."
          npx ts-node scripts/analyze_hypothesis.ts recommend || true
        continue-on-error: true

      - name: Send weekly review
        run: npx ts-node scripts/notify_discord.ts weekly-review

      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“Š Weekly review $(date -u +%Y-%m-%d)"
          git push || true
