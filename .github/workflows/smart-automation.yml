# X Marketing Engine - ã‚¹ãƒžãƒ¼ãƒˆè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ç‰¹å¾´:
# - 1æ—¥2å›žæŠ•ç¨¿ï¼ˆmorning 08:00 / night 21:00 ã®2ã‚¹ãƒ­ãƒƒãƒˆï¼‰
# - æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«ã¯C0-C7ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§é€±æ¬¡ç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
# - ãƒ—ãƒ¼ãƒ«æž¯æ¸‡æ™‚ã¯Discordã«é€šçŸ¥ã—ã¦äººé–“åˆ¤æ–­ã‚’ä»°ã
# - æ—§è‡ªå‹•ç”Ÿæˆï¼ˆåŒãƒ†ãƒ¼ãƒžç¹°ã‚Šè¿”ã—ï¼‰ã¯å»ƒæ­¢

name: Smart X Marketing

permissions:
  contents: write

on:
  schedule:
    # 1æ—¥2å›žæŠ•ç¨¿ï¼ˆmorning + nightï¼‰
    # X APIç„¡æ–™ãƒ—ãƒ©ãƒ³: 100ä»¶/æœˆ â†’ æœˆ60ä»¶ã§ã‚†ã¨ã‚Š
    - cron: '0 23 * * *'  # JST 08:00 (æœã®é€šå‹¤æ™‚é–“)
    - cron: '0 12 * * *'  # JST 21:00 (å¤œã®ãƒªãƒ©ãƒƒã‚¯ã‚¹ - ERæœ€å¼·ã‚¹ãƒ­ãƒƒãƒˆ)
  
  workflow_dispatch:
    inputs:
      action:
        description: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        type: choice
        options:
          - smart_post
          - generate
          - full_cycle

env:
  X_API_KEY: ${{ secrets.X_API_KEY }}
  X_API_SECRET: ${{ secrets.X_API_SECRET }}
  X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
  X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
  GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
  DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}

jobs:
  smart_post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Check pool and notify if low
        run: |
          # æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«æ®‹æ•°ã‚’ç¢ºèª
          POOL_COUNT=$(cat content/ab_test_pool.yml 2>/dev/null | grep -c "status: active" || echo "0")
          echo "ðŸ“¦ æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«æ®‹æ•°: $POOL_COUNT"
          if [ "$POOL_COUNT" -lt "3" ]; then
            echo "âš ï¸ ãƒ—ãƒ¼ãƒ«æž¯æ¸‡ï¼Discordã«ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡..."
            npx ts-node scripts/notify_discord.ts daily-report || true
          fi

      - name: Smart post execution
        run: npm run smart-post
        continue-on-error: true

      # ===== æŠ•ç¨¿å¾Œã®å­¦ç¿’ãƒ«ãƒ¼ãƒ—ï¼ˆæ¯Žå›žå®Ÿè¡Œï¼‰=====
      # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†: 24hä»¥ä¸ŠçµŒéŽ & 7æ—¥ä»¥å†… & æœªå–å¾—ã®æŠ•ç¨¿ã®ã¿å¯¾è±¡
      # ãƒãƒ«ã‚¯APIï¼ˆ1å›žã§æœ€å¤§100ä»¶ï¼‰ãªã®ã§æœˆ6-12å›žç¨‹åº¦ã®æ¶ˆè²»ã§åŽã¾ã‚‹
      - name: Collect metrics (daily)
        run: |
          echo "ðŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†ï¼ˆ24hä»¥ä¸ŠçµŒéŽã—ãŸæŠ•ç¨¿ï¼‰..."
          npm run metrics || true
        continue-on-error: true

      # XASåˆ†æž â†’ ä»®èª¬æ¤œè¨¼ â†’ æŽ¨è–¦ã‚’æ¯Žå›žå®Ÿè¡Œ
      # learning_state.json ã¨ next_recommendation.json ã‚’æ›´æ–°
      - name: Analyze and learn
        run: |
          echo "ðŸ§  åˆ†æžâ†’å­¦ç¿’â†’æŽ¨è–¦ã‚’å®Ÿè¡Œ..."
          npx ts-node scripts/analyze_hypothesis.ts all || true
        continue-on-error: true
      
      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true
          cp content/overseas_insights.json dashboard/overseas.json 2>/dev/null || true
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ðŸ¤– Smart post $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push || true

  # æœã®ãƒªã‚µãƒ¼ãƒï¼†ç”Ÿæˆï¼ˆ1æ—¥1å›žã€JST 08:00ï¼‰
  daily_setup:
    if: github.event.schedule == '0 23 * * *' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†ã¯æ¯Žæœå®Ÿè¡Œï¼ˆãƒãƒ«ã‚¯APIã§æœˆ6-12å›žã§åŽã¾ã‚‹ï¼‰
      - name: Collect metrics (daily)
        run: npm run metrics || true
        continue-on-error: true

      # XASåˆ†æž â†’ å­¦ç¿’æ›´æ–° â†’ æŽ¨è–¦ï¼ˆæ¯Žæœå®Ÿè¡Œã§å³åº§ã«åæ˜ ï¼‰
      - name: Analyze hypothesis and update learning
        run: npx ts-node scripts/analyze_hypothesis.ts all || true
        continue-on-error: true

      - name: Update winning patterns (numeric analysis)
        run: npx ts-node scripts/analyze_performance.ts update-winning || true
        continue-on-error: true

      - name: Multi-LLM deep analysis
        run: npm run analyze-llm || true
        continue-on-error: true
      
      - name: Grok content analysis (daily, no API limit)
        run: npm run analyze-grok || true
        continue-on-error: true
      
      - name: Get account stats
        run: npm run account-stats || true
        continue-on-error: true
      
      - name: Research overseas trends
        run: npm run research-overseas || true
        continue-on-error: true
      
      - name: Watch influencers and analyze patterns
        run: |
          npx ts-node scripts/watch_influencers.ts watch || true
          npx ts-node scripts/watch_influencers.ts analyze || true
        continue-on-error: true
      
      - name: Check pool status and notify
        run: |
          POOL_COUNT=$(cat content/ab_test_pool.yml 2>/dev/null | grep -c "status: active" || echo "0")
          echo "ðŸ“¦ æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«æ®‹æ•°: $POOL_COUNT"
          if [ "$POOL_COUNT" -lt "6" ]; then
            echo "âš ï¸ ãƒ—ãƒ¼ãƒ«æ®‹æ•°ãŒå°‘ãªã„ã§ã™ã€‚Discordã«é€šçŸ¥..."
            npx ts-node scripts/notify_discord.ts theme-candidates || true
          fi
      
      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true
          cp content/overseas_insights.json dashboard/overseas.json 2>/dev/null || true
          cp content/winning_patterns.yml dashboard/patterns.yml 2>/dev/null || true
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
          echo "{" > dashboard/logs.json
          echo "  \"last_run\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> dashboard/logs.json
          echo "  \"job\": \"daily_setup\"," >> dashboard/logs.json
          echo "  \"status\": \"success\"," >> dashboard/logs.json
          echo "  \"actions\": [" >> dashboard/logs.json
          echo "    \"metrics_collected\": true," >> dashboard/logs.json
          echo "    \"patterns_updated\": true," >> dashboard/logs.json
          echo "    \"overseas_researched\": true," >> dashboard/logs.json
          echo "    \"influencers_watched\": true," >> dashboard/logs.json
          echo "    \"posts_generated\": true" >> dashboard/logs.json
          echo "  ]" >> dashboard/logs.json
          echo "}" >> dashboard/logs.json
      
      - name: Commit daily setup
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ðŸŒ… Daily setup $(date -u +%Y-%m-%d)"
          git push || true
