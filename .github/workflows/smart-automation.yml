# X Marketing Engine - ã‚¹ãƒžãƒ¼ãƒˆè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ç‰¹å¾´:
# - 1æ—¥3å›žæŠ•ç¨¿ï¼ˆæœˆ90ä»¶ = ç„¡æ–™ãƒ—ãƒ©ãƒ³100ä»¶/æœˆã«åŽã¾ã‚‹ï¼‰
# - æœãƒ»æ˜¼ãƒ»å¤œã®åŠ¹æžœçš„ãªæ™‚é–“å¸¯ã«æŠ•ç¨¿
# - åœæ­¢ã—ã«ãã„è¨­è¨ˆ

name: Smart X Marketing

permissions:
  contents: write

on:
  schedule:
    # 1æ—¥3å›žæŠ•ç¨¿ï¼ˆæœˆ90ä»¶ã«åˆ¶é™ï¼‰
    # X APIç„¡æ–™ãƒ—ãƒ©ãƒ³: 100ä»¶/æœˆ
    - cron: '0 23 * * *'  # JST 08:00 (æœã®é€šå‹¤æ™‚é–“)
    - cron: '0 3 * * *'   # JST 12:00 (æ˜¼ä¼‘ã¿)
    - cron: '0 11 * * *'  # JST 20:00 (å¤œã®ãƒªãƒ©ãƒƒã‚¯ã‚¹)
  
  workflow_dispatch:
    inputs:
      action:
        description: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        type: choice
        options:
          - smart_post
          - generate
          - full_cycle

env:
  X_API_KEY: ${{ secrets.X_API_KEY }}
  X_API_SECRET: ${{ secrets.X_API_SECRET }}
  X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
  X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
  GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

jobs:
  smart_post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Generate posts if needed
        run: |
          # æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰ç”Ÿæˆ
          POOL_COUNT=$(cat content/ab_test_pool.yml 2>/dev/null | grep -c "status: active" || echo "0")
          if [ "$POOL_COUNT" -lt "3" ]; then
            echo "ðŸ“ æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã„ãŸã‚ã€æ–°è¦ç”Ÿæˆ..."
            npm run generate || true
            npm run generate || true
            npm run generate || true
          else
            echo "âœ… æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«: $POOL_COUNT ä»¶"
          fi
      
      - name: Smart post execution
        run: npm run smart-post
        continue-on-error: true
      
      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true
          cp content/overseas_insights.json dashboard/overseas.json 2>/dev/null || true
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ðŸ¤– Smart post $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push || true

  # æœã®ãƒªã‚µãƒ¼ãƒï¼†ç”Ÿæˆï¼ˆ1æ—¥1å›žã€JST 08:00ï¼‰
  daily_setup:
    if: github.event.schedule == '0 23 * * *' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Get day of week
        id: date
        run: echo "day=$(date -u +%a)" >> $GITHUB_OUTPUT
      
      # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†ã¯æœˆãƒ»æœ¨ã®ã¿å®Ÿè¡Œï¼ˆX APIåˆ¶é™: 1å›ž/15åˆ†ï¼‰
      - name: Collect metrics (Mon/Thu only)
        if: contains('Mon Thu', steps.date.outputs.day)
        run: npm run metrics || true
        continue-on-error: true
      
      - name: Update winning patterns (numeric analysis)
        run: npx ts-node scripts/analyze_performance.ts update-winning || true
        continue-on-error: true
      
      - name: Multi-LLM deep analysis (requires metrics)
        if: contains('Mon Thu', steps.date.outputs.day)
        run: npm run analyze-llm || true
        continue-on-error: true
      
      - name: Grok content analysis (daily, no API limit)
        run: npm run analyze-grok || true
        continue-on-error: true
      
      - name: Get account stats
        run: npm run account-stats || true
        continue-on-error: true
      
      - name: Research overseas trends
        run: npm run research-overseas || true
        continue-on-error: true
      
      - name: Watch influencers and analyze patterns
        run: |
          npx ts-node scripts/watch_influencers.ts watch || true
          npx ts-node scripts/watch_influencers.ts analyze || true
        continue-on-error: true
      
      - name: Generate day's posts (3 posts/day)
        run: |
          npm run generate || true
          npm run generate || true
          npm run generate || true
      
      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true
          cp content/overseas_insights.json dashboard/overseas.json 2>/dev/null || true
          cp content/winning_patterns.yml dashboard/patterns.yml 2>/dev/null || true
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
          echo "{" > dashboard/logs.json
          echo "  \"last_run\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> dashboard/logs.json
          echo "  \"job\": \"daily_setup\"," >> dashboard/logs.json
          echo "  \"status\": \"success\"," >> dashboard/logs.json
          echo "  \"actions\": [" >> dashboard/logs.json
          echo "    \"metrics_collected\": $(if [ \"$(date -u +%a)\" = \"Mon\" ] || [ \"$(date -u +%a)\" = \"Thu\" ]; then echo \"true\"; else echo \"false\"; fi)," >> dashboard/logs.json
          echo "    \"patterns_updated\": true," >> dashboard/logs.json
          echo "    \"overseas_researched\": true," >> dashboard/logs.json
          echo "    \"influencers_watched\": true," >> dashboard/logs.json
          echo "    \"posts_generated\": true" >> dashboard/logs.json
          echo "  ]" >> dashboard/logs.json
          echo "}" >> dashboard/logs.json
      
      - name: Commit daily setup
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ðŸŒ… Daily setup $(date -u +%Y-%m-%d)"
          git push || true
