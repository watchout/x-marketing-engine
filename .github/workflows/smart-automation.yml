# X Marketing Engine - ã‚¹ãƒžãƒ¼ãƒˆè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ç‰¹å¾´:
# - æ¯Žæ™‚å®Ÿè¡Œã—ã¦ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒé©åˆ‡ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤æ–­
# - æœªæŠ•ç¨¿ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Œã°è‡ªå‹•ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—
# - åœæ­¢ã—ã«ãã„è¨­è¨ˆ

name: Smart X Marketing

on:
  schedule:
    # æ¯Žæ™‚0åˆ†ã«å®Ÿè¡Œ (UTC)
    # JST 07:00-22:00 = UTC 22:00-13:00
    - cron: '0 22 * * *'  # JST 07:00
    - cron: '0 23 * * *'  # JST 08:00
    - cron: '0 0 * * *'   # JST 09:00
    - cron: '0 1 * * *'   # JST 10:00
    - cron: '0 2 * * *'   # JST 11:00
    - cron: '0 3 * * *'   # JST 12:00
    - cron: '0 9 * * *'   # JST 18:00
    - cron: '0 10 * * *'  # JST 19:00
    - cron: '0 11 * * *'  # JST 20:00
    - cron: '0 12 * * *'  # JST 21:00
    - cron: '0 13 * * *'  # JST 22:00
  
  workflow_dispatch:
    inputs:
      action:
        description: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        type: choice
        options:
          - smart_post
          - generate
          - full_cycle

env:
  X_API_KEY: ${{ secrets.X_API_KEY }}
  X_API_SECRET: ${{ secrets.X_API_SECRET }}
  X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
  X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
  GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

jobs:
  smart_post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Generate posts if needed
        run: |
          # æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰ç”Ÿæˆ
          POOL_COUNT=$(cat content/ab_test_pool.yml 2>/dev/null | grep -c "status: active" || echo "0")
          if [ "$POOL_COUNT" -lt "3" ]; then
            echo "ðŸ“ æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã„ãŸã‚ã€æ–°è¦ç”Ÿæˆ..."
            npm run generate || true
            npm run generate || true
            npm run generate || true
          else
            echo "âœ… æŠ•ç¨¿ãƒ—ãƒ¼ãƒ«: $POOL_COUNT ä»¶"
          fi
      
      - name: Smart post execution
        run: npm run smart-post
        continue-on-error: true
      
      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true
          cp content/overseas_insights.json dashboard/overseas.json 2>/dev/null || true
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ðŸ¤– Smart post $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push || true

  # æœã®ãƒªã‚µãƒ¼ãƒï¼†ç”Ÿæˆï¼ˆ1æ—¥1å›žï¼‰
  daily_setup:
    if: github.event.schedule == '0 22 * * *' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Collect metrics
        run: npm run metrics || true
        continue-on-error: true
      
      - name: Update winning patterns (learning)
        run: npx ts-node scripts/analyze_performance.ts update-winning || true
        continue-on-error: true
      
      - name: Get account stats
        run: npm run account-stats || true
        continue-on-error: true
      
      - name: Research overseas trends
        run: npm run research-overseas || true
        continue-on-error: true
      
      - name: Generate day's posts
        run: |
          npm run generate || true
          npm run generate || true
          npm run generate || true
          npm run generate || true
          npm run generate || true
      
      - name: Copy data to dashboard
        run: |
          cp content/post_history.json dashboard/data.json 2>/dev/null || true
          cp content/account_stats.json dashboard/account.json 2>/dev/null || true
          cp content/overseas_insights.json dashboard/overseas.json 2>/dev/null || true
      
      - name: Commit daily setup
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ðŸŒ… Daily setup $(date -u +%Y-%m-%d)"
          git push || true
