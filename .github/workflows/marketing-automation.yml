# X Marketing Engine - è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ v2.0
#
# æ—¥æ¬¡ã‚µã‚¤ã‚¯ãƒ«ï¼ˆ1æ—¥5æŠ•ç¨¿ + ãƒªãƒ—ãƒ©ã‚¤ææ¡ˆï¼‰:
#   05:45 JST - ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
#   06:00 JST - ãƒªãƒ—ãƒ©ã‚¤å€™è£œå–å¾—ï¼ˆ1ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
#   06:15 JST - ãƒªãƒ—ãƒ©ã‚¤å€™è£œå–å¾—ï¼ˆ1ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
#   07:00 JST - æŠ•ç¨¿ç”Ÿæˆï¼ˆ5ä»¶åˆ†ï¼‰
#   08:00 JST - æœæŠ•ç¨¿1
#   10:00 JST - åˆå‰æŠ•ç¨¿
#   12:00 JST - æ˜¼æŠ•ç¨¿
#   18:00 JST - å¤•æ–¹æŠ•ç¨¿
#   21:00 JST - å¤œæŠ•ç¨¿
#
# å¿…è¦ãªSecrets:
#   X_API_KEY, X_API_SECRET, X_ACCESS_TOKEN, X_ACCESS_SECRET
#   OPENAI_API_KEY, GOOGLE_AI_API_KEY
#   GROK_API_KEY (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

name: X Marketing Automation

permissions:
  contents: write

on:
  schedule:
    # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† (05:45 JST = 20:45 UTCå‰æ—¥)
    - cron: '45 20 * * *'
    # æŠ•ç¨¿ç”Ÿæˆ (07:00 JST = 22:00 UTCå‰æ—¥)
    - cron: '0 22 * * *'
    # æœæŠ•ç¨¿ (08:00 JST = 23:00 UTCå‰æ—¥)
    - cron: '0 23 * * *'
    # åˆå‰æŠ•ç¨¿ (10:00 JST = 01:00 UTC)
    - cron: '0 1 * * *'
    # æ˜¼æŠ•ç¨¿ (12:00 JST = 03:00 UTC)
    - cron: '0 3 * * *'
    # å¤•æ–¹æŠ•ç¨¿ (18:00 JST = 09:00 UTC)
    - cron: '0 9 * * *'
    # å¤œæŠ•ç¨¿ (21:00 JST = 12:00 UTC)
    - cron: '0 12 * * *'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to run'
        required: true
        default: 'generate'
        type: choice
        options:
          - generate
          - post_morning
          - post_mid_morning
          - post_noon
          - post_evening
          - post_night
          - analyze
          - suggest_replies
          - full_cycle

env:
  X_API_KEY: ${{ secrets.X_API_KEY }}
  X_API_SECRET: ${{ secrets.X_API_SECRET }}
  X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
  X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
  GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

jobs:
  # ===== ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† + åˆ†æ (05:45 JST) =====
  analyze:
    if: github.event.schedule == '45 20 * * *' || github.event.inputs.action == 'analyze' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Collect metrics
        run: npm run metrics
        continue-on-error: true
      
      - name: Analyze performance
        run: npm run analyze
        continue-on-error: true
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“Š Daily analysis"
          git push

  # ===== æŠ•ç¨¿ç”Ÿæˆ (07:00 JST) =====
  generate:
    if: github.event.schedule == '0 22 * * *' || github.event.inputs.action == 'generate' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Generate posts with Multi-LLM (5 posts)
        run: |
          npm run generate
          npm run generate
          npm run generate
          npm run generate
          npm run generate
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit posts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ§  Generated 5 posts"
          git push

  # ===== æœæŠ•ç¨¿ (08:00 JST) =====
  post_morning:
    if: github.event.schedule == '0 23 * * *' || github.event.inputs.action == 'post_morning' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Post morning content
        run: npm run post:morning
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“¤ 08:00 post"
          git push

  # ===== åˆå‰æŠ•ç¨¿ (10:00 JST) =====
  post_mid_morning:
    if: github.event.schedule == '0 1 * * *' || github.event.inputs.action == 'post_mid_morning' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Post mid-morning content
        run: npm run post:noon
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“¤ 10:00 post"
          git push

  # ===== æ˜¼æŠ•ç¨¿ (12:00 JST) =====
  post_noon:
    if: github.event.schedule == '0 3 * * *' || github.event.inputs.action == 'post_noon' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Post noon content
        run: npm run post:noon
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“¤ 12:00 post"
          git push

  # ===== å¤•æ–¹æŠ•ç¨¿ (18:00 JST) =====
  post_evening:
    if: github.event.schedule == '0 9 * * *' || github.event.inputs.action == 'post_evening' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Post evening content
        run: npm run post:night
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“¤ 18:00 post"
          git push

  # ===== å¤œæŠ•ç¨¿ (21:00 JST) =====
  post_night:
    if: github.event.schedule == '0 12 * * *' || github.event.inputs.action == 'post_night' || github.event.inputs.action == 'full_cycle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git pull origin ${{ github.ref_name }} || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Post night content
        run: npm run post:night
      
      - name: Copy data to dashboard
        run: cp content/post_history.json dashboard/data.json
      
      - name: Commit history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ dashboard/
          git diff --staged --quiet || git commit -m "ğŸ“¤ 21:00 post"
          git push

  # ===== ãƒªãƒ—ãƒ©ã‚¤ææ¡ˆç”Ÿæˆ =====
  suggest_replies:
    if: github.event.inputs.action == 'suggest_replies'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Generate reply suggestions
        run: npm run suggest-replies
        continue-on-error: true
      
      - name: Commit suggestions
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/
          git diff --staged --quiet || git commit -m "ğŸ’¬ Reply suggestions"
          git push
